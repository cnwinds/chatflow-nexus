# AI Toys 后台管理系统架构

## 系统概述

基于AI指标表的后台管理系统，提供性能监控、数据分析和可视化功能。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    AI Toys 后台管理系统                        │
├─────────────────────────────────────────────────────────────┤
│  前端层 (Frontend)                                          │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐  │
│  │   登录页面       │ │   仪表板页面     │ │   错误页面       │  │
│  │  login.html     │ │ dashboard.html │ │  404/500.html   │  │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  API层 (API Layer)                                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐  │
│  │   认证API       │ │   数据API       │ │   页面API       │  │
│  │  /admin/login  │ │ /admin/metrics │ │ /admin/dashboard│  │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层 (Business Logic)                                 │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐  │
│  │   认证管理       │ │   数据服务       │ │   配置管理       │  │
│  │   auth.py       │ │   models.py     │ │   config.py     │  │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  数据访问层 (Data Access)                                   │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐  │
│  │   数据库管理     │ │   连接池         │ │   异常处理       │  │
│  │ DatabaseManager │ │ SQLAlchemy Pool │ │   Exceptions    │  │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  数据存储层 (Data Storage)                                   │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐  │
│  │   用户表         │ │   AI指标表      │ │   其他表         │  │
│  │   users         │ │   ai_metrics   │ │   devices等     │  │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 前端层 (Frontend)

- **技术栈**: HTML5, CSS3, JavaScript, Bootstrap 5, Chart.js
- **页面组件**:
  - `login.html` - 用户登录页面
  - `dashboard.html` - 数据仪表板
  - `index.html` - 系统首页
  - `404.html`, `500.html` - 错误页面

### 2. API层 (API Layer)

- **框架**: Flask + Flask-CORS
- **路由**: `/admin/*`
- **主要接口**:
  - 认证接口: `/login`, `/logout`, `/user/info`
  - 数据接口: `/metrics/summary`, `/metrics/timeseries`
  - 页面接口: `/dashboard`, `/`

### 3. 业务逻辑层 (Business Logic)

#### 认证模块 (`auth.py`)
- 用户登录验证
- 会话管理
- 权限控制
- 密码哈希验证

#### 数据服务模块 (`models.py`)
- AI指标数据查询
- 时间序列数据处理
- 统计汇总计算
- 数据模型定义

#### 配置管理 (`config.py`)
- 系统配置
- 数据库配置
- 安全配置
- 环境变量管理

### 4. 数据访问层 (Data Access)

- **数据库**: MySQL 8.0+
- **ORM**: SQLAlchemy
- **连接池**: 支持连接池管理
- **异常处理**: 统一的异常处理机制

### 5. 数据存储层 (Data Storage)

#### 核心表结构

**用户表 (users)**
```sql
- id: 用户ID (主键)
- login_name: 登录名
- password_hash: 密码哈希
- user_name: 显示名称
- user_type: 用户类型 (0-普通用户, 1-系统用户)
- status: 状态 (0-禁用, 1-正常, 2-已删除)
```

**AI指标表 (ai_metrics)**
```sql
- id: 指标记录ID (主键)
- monitor_id: 监控ID
- provider: 提供商 (openai, azure, anthropic, google等)
- model_name: 模型名称
- start_time: 开始时间
- end_time: 结束时间
- total_time: 总耗时 (毫秒)
- cost: 总费用
- total_tokens: 总Token数
- prompt_tokens: 输入Token数
- completion_tokens: 输出Token数
```

## 数据流

### 1. 用户认证流程

```
用户输入 → 前端验证 → API接口 → 认证模块 → 数据库查询 → 密码验证 → 会话创建 → 返回结果
```

### 2. 数据查询流程

```
用户请求 → 前端处理 → API接口 → 数据服务 → 数据库查询 → 数据处理 → 返回JSON → 前端渲染
```

### 3. 图表渲染流程

```
数据查询 → 时间序列处理 → Chart.js配置 → 图表渲染 → 用户交互
```

## 安全机制

### 1. 认证安全
- 密码SHA256哈希存储
- 会话令牌管理
- 登录超时控制
- 系统用户权限验证

### 2. 数据安全
- SQL注入防护
- 参数验证
- 异常处理
- 日志记录

### 3. 访问控制
- 基于角色的权限控制
- 系统用户专用访问
- 会话超时机制

## 性能优化

### 1. 数据库优化
- 索引优化 (时间、提供商、模型联合索引)
- 查询优化 (分页、过滤)
- 连接池管理

### 2. 前端优化
- 异步数据加载
- 图表懒加载
- 响应式设计

### 3. 缓存策略
- 静态资源缓存
- 数据查询缓存
- 会话缓存

## 部署架构

### 开发环境
```
本地开发 → Python虚拟环境 → Flask开发服务器 → 本地MySQL
```

### 生产环境
```
Docker容器 → Nginx反向代理 → Flask应用 → MySQL数据库
```

### Docker部署
```yaml
services:
  admin:          # 后台管理应用
    build: ./
    ports: ["5000:5000"]
    depends_on: [mysql]
  
  mysql:          # MySQL数据库
    image: mysql:8.0
    ports: ["3306:3306"]
    volumes: [mysql_data:/var/lib/mysql]
```

## 监控和日志

### 1. 应用监控
- 健康检查接口 (`/health`)
- 服务状态监控
- 性能指标收集

### 2. 日志管理
- 应用日志 (`logs/admin.log`)
- 错误日志记录
- 访问日志记录

### 3. 数据监控
- AI指标数据统计
- 性能趋势分析
- 异常数据告警

## 扩展性设计

### 1. 模块化架构
- 独立的认证模块
- 可插拔的数据服务
- 灵活的配置管理

### 2. API设计
- RESTful API规范
- 统一的响应格式
- 版本控制支持

### 3. 数据模型
- 可扩展的数据结构
- 灵活的查询接口
- 多数据源支持

## 技术栈总结

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 前端 | HTML5/CSS3/JS | - | 基础技术 |
| 前端 | Bootstrap | 5.1.3 | UI框架 |
| 前端 | Chart.js | 3.x | 图表库 |
| 后端 | Python | 3.8+ | 编程语言 |
| 后端 | Flask | 2.3.3 | Web框架 |
| 后端 | SQLAlchemy | 2.0.21 | ORM框架 |
| 数据库 | MySQL | 8.0+ | 关系数据库 |
| 部署 | Docker | 20+ | 容器化 |
| 部署 | Docker Compose | 2.0+ | 容器编排 |
