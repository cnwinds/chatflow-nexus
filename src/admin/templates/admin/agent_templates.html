{% extends "admin/base.html" %}

{% block title %}Agent模板管理 - AI Toys 后台管理系统{% endblock %}

{% block page_title %}Agent模板管理{% endblock %}

{% block content %}
<!-- 搜索和筛选区域 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-search me-2"></i>搜索和筛选
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">模板名称</label>
                        <input type="text" class="form-control" id="searchName" placeholder="输入模板名称">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">设备类型</label>
                        <select class="form-select" id="searchDeviceType">
                            <option value="">全部设备类型</option>
                            <option value="0">其他</option>
                            <option value="1">智能音箱</option>
                            <option value="2">智能显示屏</option>
                            <option value="3">机器人</option>
                            <option value="4">车载设备</option>
                            <option value="5">可穿戴设备</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">状态</label>
                        <select class="form-select" id="searchStatus">
                            <option value="">全部状态</option>
                            <option value="0">禁用</option>
                            <option value="1">正常</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">操作</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-custom" onclick="applySearchFilter()">
                                <i class="fas fa-search me-1"></i>搜索
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSearch()">
                                <i class="fas fa-undo me-1"></i>重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 模板列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-layer-group me-2"></i>模板列表
                    <span class="badge bg-primary ms-2" id="templateCount">0</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadTemplates()">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                    <button class="btn btn-sm btn-custom" onclick="showCreateModal()">
                        <i class="fas fa-plus me-1"></i>新增模板
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>模板名称</th>
                                <th>描述</th>
                                <th>设备类型</th>
                                <th>性别</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="templatesTable">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="loading">
                                        <div class="spinner-border" role="status"></div>
                                        <div class="mt-2">加载中...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增模板弹窗 -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">
                    <i class="fas fa-plus me-2"></i>新增模板
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">模板名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="createName" placeholder="请输入模板名称">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">设备类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="createDeviceType">
                            <option value="1">智能音箱</option>
                            <option value="2">智能显示屏</option>
                            <option value="3">机器人</option>
                            <option value="4">车载设备</option>
                            <option value="5">可穿戴设备</option>
                            <option value="0">其他</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">性别</label>
                        <select class="form-select" id="createGender">
                            <option value="0">女</option>
                            <option value="1">男</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">头像URL</label>
                        <input type="text" class="form-control" id="createAvatar" placeholder="请输入头像URL">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">模板描述</label>
                    <textarea class="form-control" id="createDescription" rows="3" placeholder="请输入模板描述"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Agent配置 (JSON格式)</label>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">支持JSON格式验证和自动格式化</small>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="formatCreateJSON()">
                                <i class="fas fa-magic me-1"></i>格式化
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="validateCreateJSON()">
                                <i class="fas fa-check me-1"></i>验证
                            </button>
                        </div>
                    </div>
                    <div class="position-relative">
                        <textarea class="form-control json-editor" id="createAgentConfig" rows="15" 
                                  placeholder="请输入JSON格式的配置..." 
                                  style="font-family: 'Courier New', 'Monaco', 'Consolas', monospace; font-size: 14px; line-height: 1.5; tab-size: 2;"></textarea>
                        <div class="position-absolute top-0 end-0 p-2">
                            <small class="text-muted">支持Tab键缩进</small>
                        </div>
                    </div>
                    <div class="invalid-feedback" id="createJsonError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-custom" onclick="saveCreateTemplate()">
                    <i class="fas fa-save me-2"></i>创建模板
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑模板弹窗 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑模板
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 基本信息部分 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>基本信息</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">模板名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editName" placeholder="请输入模板名称">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">设备类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editDeviceType">
                                    <option value="1">智能音箱</option>
                                    <option value="2">智能显示屏</option>
                                    <option value="3">机器人</option>
                                    <option value="4">车载设备</option>
                                    <option value="5">可穿戴设备</option>
                                    <option value="0">其他</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">性别</label>
                                <select class="form-select" id="editGender">
                                    <option value="0">女</option>
                                    <option value="1">男</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">头像URL</label>
                                <input type="text" class="form-control" id="editAvatar" placeholder="请输入头像URL">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">模板描述</label>
                            <textarea class="form-control" id="editDescription" rows="3" placeholder="请输入模板描述"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Agent配置部分 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Agent配置</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">支持JSON格式验证和自动格式化</small>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="formatEditJSON()">
                                    <i class="fas fa-magic me-1"></i>格式化
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="validateEditJSON()">
                                    <i class="fas fa-check me-1"></i>验证
                                </button>
                            </div>
                        </div>
                        <div class="position-relative">
                            <textarea class="form-control json-editor" id="editAgentConfig" rows="15" 
                                      placeholder="请输入JSON格式的配置..." 
                                      style="font-family: 'Courier New', 'Monaco', 'Consolas', monospace; font-size: 14px; line-height: 1.5; tab-size: 2;"></textarea>
                            <div class="position-absolute top-0 end-0 p-2">
                                <small class="text-muted">支持Tab键缩进</small>
                            </div>
                        </div>
                        <div class="invalid-feedback" id="editJsonError"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-custom" onclick="saveEditTemplate()">
                    <i class="fas fa-save me-2"></i>保存修改
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 详情弹窗 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">
                    <i class="fas fa-info-circle me-2"></i>模板详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>模板ID:</strong> <span id="detailId"></span><br>
                        <strong>名称:</strong> <span id="detailName"></span><br>
                        <strong>描述:</strong> <span id="detailDescription"></span><br>
                        <strong>性别:</strong> <span id="detailGender"></span><br>
                        <strong>状态:</strong> <span id="detailStatus"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>设备类型:</strong> <span id="detailDeviceType"></span><br>
                        <strong>创建者ID:</strong> <span id="detailCreatorId"></span><br>
                        <strong>头像:</strong> <span id="detailAvatar"></span><br>
                        <strong>创建时间:</strong> <span id="detailCreatedAt"></span>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <strong>Agent配置:</strong>
                    <pre class="bg-light p-3 rounded" id="detailConfig"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-custom" onclick="editConfig()">
                    <i class="fas fa-edit me-2"></i>编辑配置
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTemplates = [];
    let currentTemplateId = null;

    // 设备类型映射
    const deviceTypeMap = {
        0: '其他',
        1: '智能音箱',
        2: '智能显示屏',
        3: '机器人',
        4: '车载设备',
        5: '可穿戴设备'
    };

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadTemplates();
        setupSearchEvents();
    });

    // 设置搜索事件监听
    function setupSearchEvents() {
        const searchInputs = ['searchName', 'searchDeviceType', 'searchStatus'];
        searchInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', function() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        applySearchFilter();
                    }, 300);
                });
            }
        });
    }

    // 加载模板列表
    async function loadTemplates() {
        try {
            showLoading();
            
            const response = await fetch('/admin/api/agent-templates');
            const result = await response.json();
            
            if (result.success) {
                currentTemplates = result.data;
                applySearchFilter();
            } else {
                console.error('加载模板失败:', result.error);
                showError('加载模板失败: ' + result.error);
            }
        } catch (error) {
            console.error('加载模板失败:', error);
            showError('加载模板失败，请重试');
        } finally {
            hideLoading();
        }
    }

    // 应用搜索过滤
    function applySearchFilter() {
        const searchName = document.getElementById('searchName').value.trim().toLowerCase();
        const searchDeviceType = document.getElementById('searchDeviceType').value;
        const searchStatus = document.getElementById('searchStatus').value;
        
        let filteredTemplates = currentTemplates.filter(template => {
            // 模板名称过滤
            if (searchName && !template.name.toLowerCase().includes(searchName)) {
                return false;
            }
            
            // 设备类型过滤
            if (searchDeviceType && template.device_type.toString() !== searchDeviceType) {
                return false;
            }
            
            // 状态过滤
            if (searchStatus && template.status.toString() !== searchStatus) {
                return false;
            }
            
            return true;
        });
        
        updateTemplatesTable(filteredTemplates);
        document.getElementById('templateCount').textContent = filteredTemplates.length;
    }

    // 更新模板表格
    function updateTemplatesTable(templates) {
        const tbody = document.getElementById('templatesTable');
        tbody.innerHTML = '';
        
        if (templates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无数据</td></tr>';
            return;
        }
        
        templates.forEach(template => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${template.id}</td>
                <td>
                    <div class="d-flex align-items-center">
                        ${template.avatar ? `<img src="${template.avatar}" class="rounded-circle me-2" width="32" height="32" alt="头像">` : '<i class="fas fa-layer-group me-2 text-muted"></i>'}
                        <strong>${template.name}</strong>
                    </div>
                </td>
                <td>${template.description || '-'}</td>
                <td>${deviceTypeMap[template.device_type] || '未知'}</td>
                <td>${template.gender === 1 ? '男' : '女'}</td>
                <td>
                    <span class="badge ${template.status === 1 ? 'bg-success' : 'bg-danger'}">
                        ${template.status === 1 ? '正常' : '禁用'}
                    </span>
                </td>
                <td>${template.created_at ? new Date(template.created_at).toLocaleString() : '-'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="showDetail(${template.id})" title="查看详情">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="editTemplate(${template.id})" title="编辑模板和配置">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTemplate(${template.id})" title="删除模板">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // 显示新增模板弹窗
    function showCreateModal() {
        // 清空表单
        document.getElementById('createName').value = '';
        document.getElementById('createDescription').value = '';
        document.getElementById('createAvatar').value = '';
        document.getElementById('createGender').value = '0';
        document.getElementById('createDeviceType').value = '1';
        document.getElementById('createAgentConfig').value = '{}';
        
        const modal = new bootstrap.Modal(document.getElementById('createModal'));
        modal.show();
        
        // 弹窗显示后自动格式化JSON
        setTimeout(() => {
            formatCreateJSONSilent();
            setupCreateJSONEditor();
        }, 100);
    }

    // 显示模板详情
    async function showDetail(templateId) {
        try {
            const response = await fetch(`/admin/api/agent-templates/${templateId}`);
            const result = await response.json();
            
            if (result.success) {
                const template = result.data;
                document.getElementById('detailId').textContent = template.id;
                document.getElementById('detailName').textContent = template.name;
                document.getElementById('detailDescription').textContent = template.description || '-';
                document.getElementById('detailGender').textContent = template.gender === 1 ? '男' : '女';
                document.getElementById('detailStatus').textContent = template.status === 1 ? '正常' : '禁用';
                document.getElementById('detailDeviceType').textContent = deviceTypeMap[template.device_type] || '未知';
                document.getElementById('detailCreatorId').textContent = template.creator_id;
                document.getElementById('detailAvatar').textContent = template.avatar || '-';
                document.getElementById('detailCreatedAt').textContent = template.created_at ? new Date(template.created_at).toLocaleString() : '-';
                document.getElementById('detailConfig').textContent = template.agent_config ? JSON.stringify(template.agent_config, null, 2) : '无配置';
                
                currentTemplateId = templateId;
                
                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
            } else {
                showError('获取模板详情失败: ' + result.error);
            }
        } catch (error) {
            console.error('获取模板详情失败:', error);
            showError('获取模板详情失败，请重试');
        }
    }

    // 编辑模板基本信息
    async function editTemplate(templateId) {
        try {
            const response = await fetch(`/admin/api/agent-templates/${templateId}`);
            const result = await response.json();
            
            if (result.success) {
                const template = result.data;
                document.getElementById('editName').value = template.name;
                document.getElementById('editDescription').value = template.description || '';
                document.getElementById('editAvatar').value = template.avatar || '';
                document.getElementById('editGender').value = template.gender;
                document.getElementById('editDeviceType').value = template.device_type;
                
                // 设置Agent配置
                let configText = '{}';
                if (template.agent_config) {
                    if (typeof template.agent_config === 'string') {
                        try {
                            const parsed = JSON.parse(template.agent_config);
                            configText = JSON.stringify(parsed, null, 2);
                        } catch (e) {
                            configText = template.agent_config;
                        }
                    } else {
                        configText = JSON.stringify(template.agent_config, null, 2);
                    }
                }
                document.getElementById('editAgentConfig').value = configText;
                
                currentTemplateId = templateId;
                
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
                
                // 弹窗显示后自动格式化JSON
                setTimeout(() => {
                    formatEditJSONSilent();
                    setupEditJSONEditor();
                }, 100);
            } else {
                showError('获取模板信息失败: ' + result.error);
            }
        } catch (error) {
            console.error('获取模板信息失败:', error);
            showError('获取模板信息失败，请重试');
        }
    }

    // 从详情弹窗编辑配置
    function editConfig() {
        bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
        editTemplate(currentTemplateId);
    }

    // 保存新增模板
    async function saveCreateTemplate() {
        const name = document.getElementById('createName').value.trim();
        const description = document.getElementById('createDescription').value.trim();
        const avatar = document.getElementById('createAvatar').value.trim();
        const gender = parseInt(document.getElementById('createGender').value);
        const deviceType = parseInt(document.getElementById('createDeviceType').value);
        const configText = document.getElementById('createAgentConfig').value.trim();
        
        if (!name) {
            showError('模板名称不能为空');
            return;
        }
        
        // 验证JSON格式
        let agentConfig = {};
        try {
            agentConfig = JSON.parse(configText);
        } catch (e) {
            showError('Agent配置JSON格式错误: ' + e.message);
            return;
        }
        
        try {
            const response = await fetch('/admin/api/agent-templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    description: description || null,
                    avatar: avatar || null,
                    gender: gender,
                    device_type: deviceType,
                    agent_config: agentConfig
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('模板创建成功');
                bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                loadTemplates(); // 刷新列表
            } else {
                showError('创建失败: ' + result.error);
            }
        } catch (error) {
            console.error('创建模板失败:', error);
            showError('创建模板失败，请重试');
        }
    }

    // 保存编辑模板
    async function saveEditTemplate() {
        const name = document.getElementById('editName').value.trim();
        const description = document.getElementById('editDescription').value.trim();
        const avatar = document.getElementById('editAvatar').value.trim();
        const gender = parseInt(document.getElementById('editGender').value);
        const deviceType = parseInt(document.getElementById('editDeviceType').value);
        const configText = document.getElementById('editAgentConfig').value.trim();
        
        if (!name) {
            showError('模板名称不能为空');
            return;
        }
        
        // 验证JSON格式
        let agentConfig = {};
        try {
            agentConfig = JSON.parse(configText);
        } catch (e) {
            showError('Agent配置JSON格式错误: ' + e.message);
            document.getElementById('editAgentConfig').classList.add('is-invalid');
            document.getElementById('editJsonError').textContent = e.message;
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/agent-templates/${currentTemplateId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    description: description || null,
                    avatar: avatar || null,
                    gender: gender,
                    device_type: deviceType,
                    agent_config: agentConfig
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('模板更新成功');
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                loadTemplates(); // 刷新列表
            } else {
                showError('更新失败: ' + result.error);
            }
        } catch (error) {
            console.error('更新模板失败:', error);
            showError('更新模板失败，请重试');
        }
    }


    // 删除模板
    async function deleteTemplate(templateId) {
        if (!confirm('确定要删除这个模板吗？删除后无法恢复。')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/agent-templates/${templateId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccess('模板删除成功');
                loadTemplates(); // 刷新列表
            } else {
                showError('删除失败: ' + result.error);
            }
        } catch (error) {
            console.error('删除模板失败:', error);
            showError('删除模板失败，请重试');
        }
    }

    // 重置搜索
    function resetSearch() {
        document.getElementById('searchName').value = '';
        document.getElementById('searchDeviceType').value = '';
        document.getElementById('searchStatus').value = '';
        applySearchFilter();
    }

    // 显示加载状态
    function showLoading() {
        const tbody = document.getElementById('templatesTable');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="loading"><div class="spinner-border" role="status"></div><div class="mt-2">加载中...</div></div></td></tr>';
    }

    // 隐藏加载状态
    function hideLoading() {
        // 加载状态会在updateTemplatesTable中被替换
    }

    // 显示成功消息
    function showSuccess(message) {
        alert('✅ ' + message);
    }

    // 显示错误消息
    function showError(message) {
        alert('❌ ' + message);
    }


    // 创建模板的JSON编辑器函数
    function formatCreateJSON() {
        const editor = document.getElementById('createAgentConfig');
        const originalValue = editor.value.trim();
        
        if (!originalValue) {
            editor.value = '{}';
            return;
        }
        
        try {
            const obj = JSON.parse(originalValue);
            const formatted = JSON.stringify(obj, null, 2);
            editor.value = formatted;
            editor.classList.remove('is-invalid');
            document.getElementById('createJsonError').textContent = '';
        } catch (e) {
            showError('JSON格式无效，无法格式化: ' + e.message);
            editor.classList.add('is-invalid');
            document.getElementById('createJsonError').textContent = e.message;
        }
    }

    function formatCreateJSONSilent() {
        const editor = document.getElementById('createAgentConfig');
        const originalValue = editor.value.trim();
        
        if (!originalValue) {
            editor.value = '{}';
            return;
        }
        
        try {
            const obj = JSON.parse(originalValue);
            const formatted = JSON.stringify(obj, null, 2);
            editor.value = formatted;
            editor.classList.remove('is-invalid');
            document.getElementById('createJsonError').textContent = '';
        } catch (e) {
            console.warn('JSON格式化失败:', e.message);
        }
    }

    function validateCreateJSON() {
        const editor = document.getElementById('createAgentConfig');
        try {
            JSON.parse(editor.value);
            editor.classList.remove('is-invalid');
            document.getElementById('createJsonError').textContent = '';
        } catch (e) {
            showError('JSON格式错误: ' + e.message);
            editor.classList.add('is-invalid');
            document.getElementById('createJsonError').textContent = e.message;
        }
    }


    // 设置创建模板的JSON编辑器
    function setupCreateJSONEditor() {
        const editor = document.getElementById('createAgentConfig');
        if (!editor) return;

        // 支持Tab键缩进
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        });

        // 自动缩进支持
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const start = this.selectionStart;
                const value = this.value;
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const currentLine = value.substring(lineStart, start);
                const indent = currentLine.match(/^\s*/)[0];
                
                let newIndent = indent;
                if (currentLine.trim().endsWith('{') || currentLine.trim().endsWith('[')) {
                    newIndent += '  ';
                }
                
                this.value = value.substring(0, start) + '\n' + newIndent + value.substring(start);
                this.selectionStart = this.selectionEnd = start + 1 + newIndent.length;
            }
        });

        // 自动闭合括号
        editor.addEventListener('keydown', function(e) {
            if (e.key === '{') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '{\n  \n}' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 3;
            } else if (e.key === '[') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '[\n  \n]' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 3;
            }
        });

        // 实时验证
        let validationTimeout;
        editor.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => {
                validateCreateJSONSilent();
            }, 1000);
        });
    }

    // 编辑模板的JSON编辑器函数
    function formatEditJSON() {
        const editor = document.getElementById('editAgentConfig');
        const originalValue = editor.value.trim();
        
        if (!originalValue) {
            editor.value = '{}';
            return;
        }
        
        try {
            const obj = JSON.parse(originalValue);
            const formatted = JSON.stringify(obj, null, 2);
            editor.value = formatted;
            editor.classList.remove('is-invalid');
            document.getElementById('editJsonError').textContent = '';
        } catch (e) {
            showError('JSON格式无效，无法格式化: ' + e.message);
            editor.classList.add('is-invalid');
            document.getElementById('editJsonError').textContent = e.message;
        }
    }

    function formatEditJSONSilent() {
        const editor = document.getElementById('editAgentConfig');
        const originalValue = editor.value.trim();
        
        if (!originalValue) {
            editor.value = '{}';
            return;
        }
        
        try {
            const obj = JSON.parse(originalValue);
            const formatted = JSON.stringify(obj, null, 2);
            editor.value = formatted;
            editor.classList.remove('is-invalid');
            document.getElementById('editJsonError').textContent = '';
        } catch (e) {
            console.warn('JSON格式化失败:', e.message);
        }
    }

    function validateEditJSON() {
        const editor = document.getElementById('editAgentConfig');
        try {
            JSON.parse(editor.value);
            editor.classList.remove('is-invalid');
            document.getElementById('editJsonError').textContent = '';
        } catch (e) {
            showError('JSON格式错误: ' + e.message);
            editor.classList.add('is-invalid');
            document.getElementById('editJsonError').textContent = e.message;
        }
    }

    function validateEditJSONSilent() {
        const editor = document.getElementById('editAgentConfig');
        try {
            JSON.parse(editor.value);
            editor.classList.remove('is-invalid');
            document.getElementById('editJsonError').textContent = '';
        } catch (e) {
            editor.classList.add('is-invalid');
            document.getElementById('editJsonError').textContent = e.message;
        }
    }

    // 设置编辑模板的JSON编辑器
    function setupEditJSONEditor() {
        const editor = document.getElementById('editAgentConfig');
        if (!editor) return;

        // 支持Tab键缩进
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        });

        // 自动缩进支持
        editor.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const start = this.selectionStart;
                const value = this.value;
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const currentLine = value.substring(lineStart, start);
                const indent = currentLine.match(/^\s*/)[0];
                
                let newIndent = indent;
                if (currentLine.trim().endsWith('{') || currentLine.trim().endsWith('[')) {
                    newIndent += '  ';
                }
                
                this.value = value.substring(0, start) + '\n' + newIndent + value.substring(start);
                this.selectionStart = this.selectionEnd = start + 1 + newIndent.length;
            }
        });

        // 自动闭合括号
        editor.addEventListener('keydown', function(e) {
            if (e.key === '{') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '{\n  \n}' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 3;
            } else if (e.key === '[') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '[\n  \n]' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 3;
            }
        });

        // 实时验证
        let validationTimeout;
        editor.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => {
                validateEditJSONSilent();
            }, 1000);
        });
    }
</script>
{% endblock %}
